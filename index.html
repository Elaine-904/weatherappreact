<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AETHER | Live Cinematic Weather</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Outfit:wght@200;300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-heavy: rgba(15, 15, 20, 0.75);
            --glass-light: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-gold: #D4AF37;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --ease-cinema: cubic-bezier(0.25, 1, 0.5, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            background: #000;
            font-family: 'Outfit', sans-serif;
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- 1. SCENE & LAYERS --- */
        .viewport {
            position: relative;
            width: 100vw; height: 100vh;
            overflow: hidden;
            perspective: 1000px;
        }

        /* Background Layer */
        .bg-layer {
            position: absolute;
            top: -10%; left: -10%;
            width: 120%; height: 120%;
            background-size: cover;
            background-position: center;
            transition: transform 2s var(--ease-cinema), filter 1.5s ease;
            z-index: 0;
        }
        
        /* Cinematic Zoom Effect Class */
        .scene-zoom-out { animation: zoomPulse 1.5s ease forwards; }
        @keyframes zoomPulse {
            0% { transform: scale(1); filter: blur(0); }
            50% { transform: scale(0.95); filter: blur(10px) brightness(0.5); }
            100% { transform: scale(1); filter: blur(0); }
        }

        /* Atmosphere Tint (Day/Night) */
        .atmosphere-tint {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 0%, #000 100%);
            transition: background 2s ease, opacity 2s ease;
            z-index: 1;
            pointer-events: none;
        }

        /* Transition Effects Layer */
        .fx-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5;
            overflow: hidden;
        }

        /* Light Sweep FX */
        .light-sweep {
            position: absolute;
            top: 0; left: -100%;
            width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: skewX(-20deg);
            opacity: 0;
        }
        .play-sweep { animation: sweep 1.2s ease-out forwards; }
        @keyframes sweep { 0% { left: -50%; opacity: 0; } 50% { opacity: 1; } 100% { left: 150%; opacity: 0; } }

        /* Flash FX (Lightning/Scene Change) */
        .flash-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: white;
            opacity: 0;
        }
        .play-flash { animation: flash 0.8s ease-out forwards; }
        @keyframes flash { 0% { opacity: 0.8; } 100% { opacity: 0; } }

        /* Canvas */
        #particle-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none;
        }

        /* --- 2. INTRO --- */
        #intro-curtain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1.5s ease, visibility 1.5s;
        }
        .intro-title { font-family: 'Cinzel', serif; font-size: 3rem; letter-spacing: 0.5em; margin-bottom: 20px; color: #fff; opacity: 0; animation: fadeUp 1.5s forwards 0.2s; }
        .start-btn {
            padding: 15px 40px; border: 1px solid rgba(255,255,255,0.3);
            background: transparent; color: #fff; font-family: 'Outfit'; letter-spacing: 2px;
            cursor: pointer; border-radius: 50px; opacity: 0; animation: fadeUp 1.5s forwards 1s;
            transition: 0.3s;
        }
        .start-btn:hover { background: rgba(255,255,255,0.1); letter-spacing: 4px; }

        /* --- 3. UI LAYOUT --- */
        .interface-layer {
            position: relative; z-index: 10; width: 100%; height: 100%;
            display: grid; grid-template-columns: 1fr 400px; padding: 40px; gap: 30px;
            opacity: 0; transform: scale(1.02);
            transition: opacity 1s ease, transform 1s var(--ease-cinema);
        }

        .hero-section { display: flex; flex-direction: column; justify-content: space-between; }
        
        .search-bar {
            background: rgba(0,0,0,0.4); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 50px;
            padding: 12px 25px; display: flex; align-items: center; gap: 10px;
            width: 300px; transition: 0.3s;
        }
        .search-bar input { background: none; border: none; outline: none; color: #fff; width: 100%; font-size: 1rem; }

        .city-info { margin-bottom: 40px; }
        .city-title { font-family: 'Playfair Display'; font-size: 5rem; line-height: 1; margin-bottom: 10px; text-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .mood-text { font-size: 1.1rem; font-style: italic; color: var(--text-secondary); border-left: 3px solid var(--accent-gold); padding-left: 15px; max-width: 500px; }
        .hero-temp { font-size: 8rem; font-weight: 200; line-height: 0.9; }

        /* Glass Panel */
        .glass-panel {
            background: var(--glass-heavy); backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border); border-radius: 30px; padding: 30px;
            display: flex; flex-direction: column; gap: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            overflow-y: auto; scrollbar-width: none;
        }
        .glass-panel::-webkit-scrollbar { display: none; }

        .panel-header { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-secondary); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; display: flex; justify-content: space-between; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; }
        .stat-label { font-size: 0.7rem; opacity: 0.7; display: block; }
        .stat-val { font-size: 1.1rem; font-weight: 500; }

        .forecast-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* Controls */
        .controls { position: absolute; bottom: 40px; left: 40px; display: flex; gap: 15px; }
        .btn-icon { width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; color: white; }
        .btn-icon:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .btn-icon.active { background: var(--accent-gold); color: #000; }

        /* Tarot Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 100;
            display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.5s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .tarot-card {
            width: 300px; height: 500px; background: linear-gradient(135deg, #111, #222);
            border: 2px solid var(--accent-gold); border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
            transform: rotateY(90deg); transition: transform 0.8s ease; box-shadow: 0 0 40px rgba(212,175,55,0.3);
        }
        .tarot-card.flipped { transform: rotateY(0deg); }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile */
        @media (max-width: 900px) {
            .interface-layer { grid-template-columns: 1fr; padding: 20px; overflow-y: auto; display: block; }
            .glass-panel { margin-top: 20px; min-height: 50vh; }
            .city-title { font-size: 3.5rem; }
            .hero-temp { font-size: 6rem; }
            .controls { position: relative; bottom: auto; left: auto; margin-top: 20px; justify-content: center; }
        }
    </style>
</head>
<body>

    <!-- FX LAYERS -->
    <div class="fx-layer">
        <div class="light-sweep" id="fx-sweep"></div>
        <div class="flash-overlay" id="fx-flash"></div>
    </div>

    <!-- INTRO -->
    <div id="intro-curtain">
        <div class="intro-title">AETHER II</div>
        <div style="color: #888; margin-bottom: 30px; font-size: 0.9rem;">LIVE DATA | PROCEDURAL POETRY | AUDIO ENGINE</div>
        <button class="start-btn" onclick="initApp()">INITIALIZE ATMOSPHERE</button>
    </div>

    <!-- SCENE -->
    <div class="viewport">
        <div class="bg-layer" id="bg-image"></div>
        <div class="atmosphere-tint" id="tint-overlay"></div>
        <canvas id="particle-canvas"></canvas>

        <!-- INTERFACE -->
        <div class="interface-layer" id="ui-layer">
            <div class="hero-section">
                <div class="search-bar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="search-input" placeholder="Search City..." autocomplete="off">
                </div>

                <div class="city-info">
                    <h1 class="city-title" id="city-name">--</h1>
                    <p class="mood-text" id="mood-quote">"Initializing procedural emotion engine..."</p>
                    <div class="hero-temp"><span id="temp-val">--</span>Â°</div>
                </div>

                <div class="controls">
                    <div class="btn-icon" onclick="toggleSound()" id="btn-sound" title="Ambient Sound">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                    </div>
                    <div class="btn-icon" onclick="showTarot()" title="Weather Tarot">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                    </div>
                </div>
            </div>

            <div class="glass-panel">
                <div class="panel-header"><span>Live Conditions</span> <span id="local-time">--:--</span></div>
                <div class="stats-grid">
                    <div class="stat-box"><span class="stat-label">Feels Like</span><span class="stat-val" id="feels-like">--</span></div>
                    <div class="stat-box"><span class="stat-label">Humidity</span><span class="stat-val" id="humidity">--</span></div>
                    <div class="stat-box"><span class="stat-label">Wind</span><span class="stat-val" id="wind">--</span></div>
                    <div class="stat-box"><span class="stat-label">Rain Chance</span><span class="stat-val" id="precip">--</span></div>
                </div>
                <div class="panel-header" style="margin-top:20px">Sun Cycle</div>
                <div class="stats-grid">
                    <div class="stat-box"><span class="stat-label">Sunrise</span><span class="stat-val" id="sunrise">--</span></div>
                    <div class="stat-box"><span class="stat-label">Sunset</span><span class="stat-val" id="sunset">--</span></div>
                </div>
                <div class="panel-header" style="margin-top:20px">Forecast</div>
                <div id="forecast-list"></div>
            </div>
        </div>
    </div>

    <!-- TAROT MODAL -->
    <div class="modal-overlay" id="tarot-modal" onclick="closeTarot()">
        <div class="tarot-card" id="tarot-card">
            <div style="font-size: 4rem; margin-bottom: 20px;" id="tarot-icon">ðŸ”®</div>
            <h2 style="color:var(--accent-gold); font-family:'Cinzel'; margin-bottom:10px;" id="tarot-title">--</h2>
            <p style="font-family:'Playfair Display'; font-style:italic; color:#ccc;" id="tarot-desc">--</p>
        </div>
    </div>

<script>
    /* --- 1. CONFIG & STATE --- */
    const API_GEO = "https://geocoding-api.open-meteo.com/v1/search";
    const API_WEATHER = "https://api.open-meteo.com/v1/forecast";
    
    const state = {
        city: "London",
        lat: 0, lon: 0,
        weatherCode: 0,
        isDay: true,
        temp: 0,
        soundEnabled: false,
        currentAudio: null
    };

    // Curated High-Res Unsplash Backgrounds (No random API needed)
    const backgrounds = {
        clear_day: "https://images.unsplash.com/photo-1604228741406-3faa38f4907a?q=80&w=2400&auto=format&fit=crop", // Blue Sky
        clear_night: "https://images.unsplash.com/photo-1532978873691-590510753d84?q=80&w=2400&auto=format&fit=crop", // Stars
        cloudy_day: "https://images.unsplash.com/photo-1594492215538-d3f639065f32?q=80&w=2400&auto=format&fit=crop", // Soft Clouds
        cloudy_night: "https://images.unsplash.com/photo-1532563262212-274ec955617e?q=80&w=2400&auto=format&fit=crop", // Dark Clouds
        rain_day: "https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?q=80&w=2400&auto=format&fit=crop", // Rain Glass
        rain_night: "https://images.unsplash.com/photo-1503899036084-c55cdd92da26?q=80&w=2400&auto=format&fit=crop", // Neon Rain
        snow: "https://images.unsplash.com/photo-1483664852095-d6cc6870705d?q=80&w=2400&auto=format&fit=crop", // Snow
        fog: "https://images.unsplash.com/photo-1487621167305-5d248087c724?q=80&w=2400&auto=format&fit=crop", // Fog
        storm: "https://images.unsplash.com/photo-1605727216801-e27ce1ca0728?q=80&w=2400&auto=format&fit=crop" // Lightning
    };

    /* --- 2. INIT & TRANSITIONS --- */
    function initApp() {
        document.getElementById('intro-curtain').style.opacity = 0;
        setTimeout(() => document.getElementById('intro-curtain').style.visibility = 'hidden', 1500);
        
        document.getElementById('ui-layer').style.opacity = 1;
        document.getElementById('ui-layer').style.transform = 'scale(1)';
        
        fetchWeather("Tokyo"); // Default start
        initAudioEngine();
    }

    function triggerTransitions(type) {
        // 1. Light Sweep
        const sweep = document.getElementById('fx-sweep');
        sweep.classList.remove('play-sweep');
        void sweep.offsetWidth; // Trigger Reflow
        sweep.classList.add('play-sweep');

        // 2. Flash (if storm or major change)
        if(type === 'storm' || Math.random() > 0.8) {
            const flash = document.getElementById('fx-flash');
            flash.classList.remove('play-flash');
            void flash.offsetWidth;
            flash.classList.add('play-flash');
        }

        // 3. Scene Zoom Out/In
        const bg = document.getElementById('bg-image');
        bg.classList.remove('scene-zoom-out');
        void bg.offsetWidth;
        bg.classList.add('scene-zoom-out');
    }

    /* --- 3. DATA ENGINE (Open-Meteo) --- */
    document.getElementById('search-input').addEventListener('keydown', (e) => {
        if(e.key === 'Enter') fetchWeather(e.target.value);
    });

    async function fetchWeather(city) {
        try {
            // A. Geocoding
            const geoRes = await fetch(`${API_GEO}?name=${city}&count=1`);
            const geoData = await geoRes.json();
            
            if(!geoData.results) throw new Error("City not found");
            
            state.lat = geoData.results[0].latitude;
            state.lon = geoData.results[0].longitude;
            state.city = geoData.results[0].name;
            state.country = geoData.results[0].country;

            // B. Weather Data
            const wRes = await fetch(`${API_WEATHER}?latitude=${state.lat}&longitude=${state.lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,showers,snowfall,weather_code,wind_speed_10m&hourly=temperature_2m&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`);
            const data = await wRes.json();

            updateUI(data);
        } catch (e) {
            console.error(e);
            document.getElementById('search-input').style.borderColor = 'red';
            setTimeout(()=> document.getElementById('search-input').style.borderColor = 'rgba(255,255,255,0.15)', 1000);
        }
    }

    function updateUI(data) {
        const current = data.current;
        const daily = data.daily;

        state.temp = Math.round(current.temperature_2m);
        state.weatherCode = current.weather_code;
        state.isDay = current.is_day === 1;

        // Update Text
        document.getElementById('city-name').innerText = state.city;
        document.getElementById('temp-val').innerText = state.temp;
        document.getElementById('feels-like').innerText = Math.round(current.apparent_temperature) + "Â°";
        document.getElementById('humidity').innerText = current.relative_humidity_2m + "%";
        document.getElementById('wind').innerText = current.wind_speed_10m + " km/h";
        document.getElementById('precip').innerText = current.precipitation + " mm";
        document.getElementById('sunrise').innerText = daily.sunrise[0].split('T')[1];
        document.getElementById('sunset').innerText = daily.sunset[0].split('T')[1];
        
        // Local Time
        const now = new Date();
        document.getElementById('local-time').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        // Forecast
        const fList = document.getElementById('forecast-list');
        fList.innerHTML = '';
        for(let i=1; i<=4; i++) {
            const day = new Date(daily.time[i]).toLocaleDateString('en-US', {weekday: 'short'});
            fList.innerHTML += `
                <div class="forecast-row">
                    <span style="width:50px">${day}</span>
                    <span>${Math.round(daily.temperature_2m_max[i])}Â° / ${Math.round(daily.temperature_2m_min[i])}Â°</span>
                </div>
            `;
        }

        // --- VISUAL ENGINE CALLS ---
        updateAtmosphere(state.weatherCode, state.isDay);
        generateAIContent(state.weatherCode, state.isDay);
    }

    /* --- 4. VISUAL ENGINE --- */
    function updateAtmosphere(code, isDay) {
        triggerTransitions(getWeatherType(code));
        
        const bg = document.getElementById('bg-image');
        const tint = document.getElementById('tint-overlay');
        let bgUrl = "";
        let particleType = "none";
        let tintColor = "";

        // Mapping Logic
        // Codes: 0-3 (Clear/Cloud), 45-48 (Fog), 51-67 (Rain), 71-77 (Snow), 95-99 (Storm)
        if (code <= 3) {
            bgUrl = isDay ? backgrounds.clear_day : backgrounds.clear_night;
            particleType = isDay ? "sun" : "night";
            tintColor = isDay ? "radial-gradient(circle, rgba(255,200,100,0.1), transparent)" : "radial-gradient(circle, transparent, #000)";
            if(code > 1) bgUrl = isDay ? backgrounds.cloudy_day : backgrounds.cloudy_night; 
        } else if (code >= 45 && code <= 48) {
            bgUrl = backgrounds.fog;
            particleType = "fog";
            tintColor = "linear-gradient(to top, rgba(50,50,60,0.8), transparent)";
        } else if (code >= 51 && code <= 67) {
            bgUrl = isDay ? backgrounds.rain_day : backgrounds.rain_night;
            particleType = "rain";
            tintColor = "linear-gradient(to bottom, rgba(0,10,30,0.4), rgba(0,0,0,0.8))";
        } else if (code >= 71 && code <= 86) {
            bgUrl = backgrounds.snow;
            particleType = "snow";
            tintColor = "radial-gradient(circle, rgba(200,220,255,0.2), #000)";
        } else if (code >= 95) {
            bgUrl = backgrounds.storm;
            particleType = "rain";
            tintColor = "linear-gradient(to bottom, #110022, #000)";
        }

        // Apply
        setTimeout(() => {
            bg.style.backgroundImage = `url('${bgUrl}')`;
            tint.style.background = tintColor;
            initParticles(particleType);
            if(state.soundEnabled) playAudioTheme(particleType, isDay);
        }, 750); // Sync with zoom effect
    }

    function getWeatherType(code) {
        if(code <=3) return 'clear';
        if(code >=95) return 'storm';
        return 'cloudy';
    }

    /* --- 5. PROCEDURAL "AI" TEXT ENGINE --- */
    function generateAIContent(code, isDay) {
        // POETRY GENERATOR
        const subjects = ["The sky", "The wind", "This light", "The horizon", "Silence"];
        const verbs = ["whispers", "embraces", "holds", "reflects", "paints"];
        const objects = ["secrets of the day", "your quiet thoughts", "the city's dreams", "a gentle promise", "the rhythm of time"];
        
        let mood = "";
        
        if(code >= 51) { // Rain
            mood = `Rain falls like ${["soft memories", "liquid time", "gentle forgiveness"][Math.floor(Math.random()*3)]}.`;
        } else if (code <= 3 && isDay) { // Sun
            mood = `The sun ${["awakens new hope", "kisses the earth", "brings clarity"][Math.floor(Math.random()*3)]} today.`;
        } else if (!isDay) { // Night
            mood = `Night wraps the city in ${["velvet mystery", "star-lit silence", "deep calm"][Math.floor(Math.random()*3)]}.`;
        } else {
            // Random poetic construction
            mood = `${subjects[Math.floor(Math.random()*subjects.length)]} ${verbs[Math.floor(Math.random()*verbs.length)]} ${objects[Math.floor(Math.random()*objects.length)]}.`;
        }
        document.getElementById('mood-quote').innerText = `"${mood}"`;

        // TAROT GENERATOR
        const tarotMap = {
            clear: { name: "The Sun", icon: "â˜€ï¸", desc: "Success, radiance, and abundance shine upon you." },
            cloud: { name: "The Hermit", icon: "ðŸŒ«ï¸", desc: "A time for introspection and seeking inner answers." },
            rain: { name: "The Tower", icon: "âš¡", desc: "Sudden change brings cleansing and new foundations." },
            night: { name: "The Moon", icon: "ðŸŒ™", desc: "Trust your intuition; not everything is as it appears." },
            snow: { name: "The Star", icon: "â„ï¸", desc: "Hope, renewal, and serenity in the stillness." }
        };

        let type = "cloud";
        if(code <= 1 && isDay) type = "clear";
        else if(code <= 1 && !isDay) type = "night";
        else if(code >= 51) type = "rain";
        else if(code >= 71) type = "snow";

        const card = tarotMap[type];
        document.getElementById('tarot-title').innerText = card.name;
        document.getElementById('tarot-icon').innerText = card.icon;
        document.getElementById('tarot-desc').innerText = card.desc;
    }

    function showTarot() {
        document.getElementById('tarot-modal').classList.add('active');
        setTimeout(() => document.getElementById('tarot-card').classList.add('flipped'), 100);
    }
    function closeTarot() {
        document.getElementById('tarot-modal').classList.remove('active');
        document.getElementById('tarot-card').classList.remove('flipped');
    }

    /* --- 6. PARTICLE SYSTEM (WebGL-Style Canvas) --- */
    const canvas = document.getElementById('particle-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    class Particle {
        constructor(type) { this.init(type); }
        init(type) {
            this.type = type;
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.speed = Math.random() * 2 + 1;
            this.size = Math.random() * 2 + 0.5;
            
            if(type === 'rain') {
                this.color = 'rgba(200,220,255,0.5)';
                this.vy = Math.random() * 15 + 10;
                this.len = Math.random() * 20 + 10;
                this.y = Math.random() * -canvas.height;
            } else if (type === 'snow') {
                this.color = 'rgba(255,255,255,0.8)';
                this.vy = Math.random() * 2 + 0.5;
                this.vx = Math.random() * 1 - 0.5;
            } else if (type === 'sun') {
                this.color = `rgba(255,215,0,${Math.random() * 0.2})`;
                this.size = Math.random() * 30 + 10; // Bokeh
                this.vx = Math.random() * 0.5 - 0.25;
                this.vy = Math.random() * 0.5 - 0.25;
            } else { // Night/Fog
                this.color = `rgba(255,255,255,${Math.random() * 0.4})`;
                this.vx = Math.random() * 0.2;
            }
        }
        update() {
            if(this.type === 'rain') {
                this.y += this.vy;
                if(this.y > canvas.height) this.init('rain');
            } else if (this.type === 'snow') {
                this.y += this.vy; this.x += this.vx;
                if(this.y > canvas.height) this.init('snow');
            } else if (this.type === 'sun') {
                this.x += this.vx; this.y += this.vy;
                if(this.x < 0 || this.x > canvas.width) this.vx *= -1;
            } else {
                this.x += this.vx;
                if(this.x > canvas.width) this.x = 0;
            }
        }
        draw() {
            ctx.beginPath();
            if(this.type === 'rain') {
                ctx.lineWidth = 2; ctx.strokeStyle = this.color;
                ctx.moveTo(this.x, this.y); ctx.lineTo(this.x, this.y + this.len); ctx.stroke();
            } else {
                ctx.fillStyle = this.color; ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
            }
        }
    }

    function initParticles(type) {
        particles = [];
        let count = type === 'rain' ? 200 : 100;
        if(type === 'sun') count = 25;
        for(let i=0; i<count; i++) particles.push(new Particle(type));
    }

    function animateParticles() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        particles.forEach(p => { p.update(); p.draw(); });
        requestAnimationFrame(animateParticles);
    }
    animateParticles();

    /* --- 7. AUDIO ENGINE --- */
    // Note: Using generic CDN sounds for demonstration. 
    const sounds = {
        rain: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8c8a73467.mp3", // Rain
        sun: "https://cdn.pixabay.com/download/audio/2022/03/24/audio_c9257e1279.mp3", // Birds/Nature
        night: "https://cdn.pixabay.com/download/audio/2021/09/06/audio_7b276886e8.mp3" // Crickets
    };
    let audioCtx, activeSource, gainNode;

    function initAudioEngine() {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            gainNode = audioCtx.createGain();
            gainNode.connect(audioCtx.destination);
            gainNode.gain.value = 0.3; // volume
        } catch(e) { console.log("Audio API not supported"); }
    }

    function toggleSound() {
        state.soundEnabled = !state.soundEnabled;
        const btn = document.getElementById('btn-sound');
        
        if(state.soundEnabled) {
            btn.classList.add('active');
            if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            // Determine what sound to play based on current state
            let type = "sun";
            if(state.weatherCode >= 51) type = "rain";
            else if(!state.isDay) type = "night";
            playAudioTheme(type);
        } else {
            btn.classList.remove('active');
            if(activeSource) { activeSource.stop(); activeSource = null; }
        }
    }

    function playAudioTheme(type) {
        if(!state.soundEnabled || !audioCtx) return;
        
        // Simple placeholder logic: In a real production app, 
        // we would fetch the buffer and cross-fade.
        // Here we restart the audio element logic for simplicity in a single file.
        
        if(activeSource) { activeSource.stop(); }
        
        const url = sounds[type] || sounds.sun;
        
        // Fetch and play buffer
        fetch(url)
            .then(response => response.arrayBuffer())
            .then(arrayBuffer => audioCtx.decodeAudioData(arrayBuffer))
            .then(audioBuffer => {
                if(!state.soundEnabled) return;
                const source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;
                source.loop = true;
                source.connect(gainNode);
                source.start();
                activeSource = source;
            })
            .catch(e => console.error("Audio fetch error:", e));
    }

</script>
</body>
</html>